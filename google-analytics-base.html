<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../google-apis/google-client-api.html">
<link rel="import" href="../native-promise-only/lib/npo.src.js">

<!--
The base element for other google analytics elements. This element is not
intended to be used by itself. It is only intended to be subclassed.

@element google-analytics-base
@blurb Base element for other google analytics elements
@status alpha
@homepage http://polymerlabs.github.io/google-analytics
-->

<polymer-element name="google-analytics-base">
  <template>
    <google-api-loader
      name="analytics"
      version="v3">
    </google-api-loader>
  </template>

  <script>

    (function() {

      var isLoaded = false;
      var isAuthorized = false;

      /**
       * A promise that is resolved when the underlying client libraries are
       * loaded.
       */
      var loadPromise = new Promise(function(resolve, reject) {
        document.addEventListener('google-api-load', function(event) {
          var lib = event.detail;
          if (lib.name == 'analytics' && lib.version == 'v3') {
            isLoaded = true;
            resolve(event.detail)
          }
        })
        document.addEventListener('google-api-load-error', function(event) {
          reject(event.detail)
        });
      });

      /**
       * A promise that is resolved once the user has successfully signed in.
       */
      var authorizedPromise = new Promise(function(resolve, reject) {
        document.addEventListener('google-signin-success', function(event) {
          isAuthorized = true;
          resolve(event.detail.result);
        });
      });

      Polymer('google-analytics-base', {

        /**
         * The `loaded` attribute is true when the underlying analytics library
         * is fully loaded.
         *
         * @attribute loaded
         * @type boolean
         */
        get isLoaded() {
          return isLoaded;
        },

        /**
         * The `authorized` attribute is true once the user successfully signs in.
         *
         * @attribute authorized
         * @type boolean
         */
        get isAuthorized() {
          return isAuthorized;
        },

        created: function() {
          Promise
              .all([loadPromise, authorizedPromise])
              .then(function(value) {
                var authorizedPromiseValue = value[1];
                this.authorized(authorizedPromiseValue);
              }.bind(this))
              .catch(function(err) {
                console.error(err.stack || err);
              });
        },

        /**
         * The `authorized` method will be invoked when the user has
         * successfully signed in and all the underlying client libraries
         * have been loaded.
         *
         * @method authorized
         * @param {Object} data - The auth data information.
         */
        authorized: function(data) {
          // Override in a subclass.
        }

      });

    }());

  </script>

</polymer-element>
