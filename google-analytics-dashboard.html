<link rel="import" href="google-analytics-base.html">

<!--
Element for grouping Google Analytics elements together.

`<google-analytics-chart>` elements inside a `<google-analytics-dashboard>`
element will automatically update as control elements (e.g.
`<google-analytics-view-selector>` or `<google-analytics-date-selector>`)
update query parameters.

##### Example

    <google-analytics-dashboard>

      <google-analytics-view-selector></google-analytics-view-selector>
      <google-analytics-date-selector></google-analytics-date-selector>

      <google-analytics-chart
        metrics="ga:sessions"
        dimensions="ga:country"
        sort="-ga:sessions"
        maxResults="5"
        chartType="column">
      </google-analytics-chart>

    </google-analytics-dashboard>

@element google-analytics-dashboard
@extends google-analytics-base
@blurb Element for grouping Google Analytics control and visualization elements.
@status alpha
@homepage http://polymerlabs.github.io/google-analytics
-->

<polymer-element
  name="google-analytics-dashboard"
  extends="google-analytics-base">

  <template>
    <content></content>
  </template>

  <script>

    Polymer('google-analytics-dashboard', {

      /**
       * The `query` attribute represents the internal query object of this
       * dashboard. It is updated when control elements fire the
       * `analytics-dashboard-control-change` event and pass along query data.
       *
       * @attribute query
       * @type object
       */
      query: {},

      created: function() {
        this.super();
        this.unauthorized(); // Assume unauthorized state at first.

        this.addEventListener('analytics-dashboard-control-change', function(event) {

          // Update `this.query` with the passed event data.
          Object.keys(event.detail).forEach(function(key) {
            this.query[key] = event.detail[key];
          }.bind(this))

          if (this.isAuthorized) this.updateChildren();

          // This event is only relevant to google-analytics-dashboard elements
          // and their children, so no need to bubble up to the document
          event.stopPropagation();

        }.bind(this));
      },

      authorized: function() {
        this.removeAttribute('unauthorized');
        this.setAttribute('authorized', '');
        this.updateChildren();
      },

      unauthorized: function() {
        this.removeAttribute('authorized');
        this.setAttribute('unauthorized', '');
      },

      /**
       * The `updateChildren` method updates each of this dashboards
       * `<google-analytics-chart>` element with it's current query value.
       *
       * @method getData
       */
      updateChildren: function() {
        var charts = this.querySelectorAll('google-analytics-chart');
        for (var i = 0, chart; chart = charts[i]; i++) {
          Object.keys(this.query).forEach(function(key) {
            chart[key] = this.query[key];
          }.bind(this));
        }
      }

    });

  </script>

</polymer-element>
