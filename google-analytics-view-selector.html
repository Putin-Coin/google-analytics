<link rel="import" href="../native-promise-only/">

<!--
Element for selecting the view ID (ids) value for queries inside a
`<google-analytics-dashboard>` element.

##### Example

    <google-analytics-dashboard>

      <google-analytics-view-selector></google-analytics-view-selector>

      <google-analytics-chart
        metrics="ga:sessions"
        dimensions="ga:date">
      </google-analytics-chart>

    </google-analytics-dashboard>

@element google-analytics-view-selector
@blurb Element for selecting the ids value for Google Analytics queries
@status alpha
@homepage http://polymerlabs.github.io/google-analytics
-->

<polymer-element
  name="google-analytics-view-selector"
  extends="google-analytics-base">

  <template>
    <label>
      Account
      <select id="account" on-change="{{changeAccount}}">
        <template repeat="{{account,i in accounts}}">
          <option value="{{i}}">{{account.name}}</option>
        </template>
      </select>
    </label>
    <label>
      Property
      <select id="property" on-change="{{changeProperty}}">
        <template repeat="{{property,i in properties}}">
          <option value="{{i}}">{{property.name}}</option>
        </template>
      </select>
    </label>
    <label>
      View
      <select id="view" on-change="{{changeView}}">
        <template repeat="{{view,i in views}}">
          <option value="{{view.ids}}">{{view.name}}</option>
        </template>
      </select>
    </label>
  </template>

  <script>

    (function() {

      Polymer('google-analytics-view-selector', {

        /**
         * The `accounts` attribute is used to populate the `<option>`
         * elements in the account `<select>`.
         *
         * @attribute accounts
         * @type Array
         */
        accounts: [],

        /**
         * The `properties` attribute is used to populate the `<option>`
         * elements in the property `<select>`.
         *
         * @attribute properties
         * @type Array
         */
        properties: [],

        /**
         * The `views` attribute is used to populate the `<option>` elements
         * in the view `<select>`.
         *
         * @attribute views
         * @type Array
         */
        views: [],

        analyticsAuthorize: function() {

          accountSummaries.get().then(function(accounts) {

            this.accounts = accounts;
            this.properties = this.accounts[0].properties;
            this.views = this.properties[0].views;

            this.ids = this.views[0].ids;

          }.bind(this));

        },

        /**
         * The `changeAccount` method is bound to the change event on the
         * account `<select>`. It updates the property and view `<select>`s based
         * on the new account data. It also updates the `ids` attribute.
         *
         * @method changeAccount
         */
        changeAccount: function() {
          var account = this.$.account.value;
          this.properties = this.accounts[account].properties;
          this.views = this.properties[0].views;

          this.ids = this.views[0].ids;
        },

        /**
         * The `changeProperty` method is bound to the change event on the
         * property `<select>`. It updates the view `<select>` based
         * on the new property data. It also updates the `ids` attribute.
         *
         * @method changeProperty
         */
        changeProperty: function() {
          var property = this.$.property.value;
          this.views = this.properties[property].views;

          this.ids = this.views[0].ids;
        },

        /**
         * The `changeView` method is bound to the change event on the
         * view `<select>`. It updates the `ids` attribute.
         *
         * @method changeView
         */
        changeView: function() {
          this.ids = this.$.view.value;
        },

        idsChanged: function() {
          this.fire('analytics-query-change', {ids: this.ids});
        }

      });


      /**
       * @module accountSummaries
       */
      var accountSummaries = (function() {

        var promise;

        /**
         * Make a request to the Management API's accountSummaries#list method.
         * If the requests returns a partial, paginated response, query again
         * until the full summaries are retrieved.
         * @return {Promise} A promise that will be resolved once all requests
         *   are complete.
         */
        function requestAccountSummaries() {
          return new Promise(function(resolve, reject) {
            var summaries = [];
            function makeRequest(startIndex) {
              gapi.client.analytics.management.accountSummaries
                  .list({'start-index': startIndex || 1})
                  .execute(ensureComplete);
            }
            function ensureComplete(resp) {
              // Reject the promise if the API returns an error.
              if (resp.error) return reject(new Error(resp.message));

              if (resp.items) summaries = summaries.concat(resp.items);
              if (resp.startIndex + resp.itemsPerPage <= resp.totalResults) {
                makeRequest(resp.startIndex + resp.itemsPerPage);
              }
              else {
                resolve(summaries);
              }
            }
            makeRequest();
          });
        }

        /**
         * Loop through the full account summaries array and create a new array
         * the only contains the account, property, and view names and their
         * children. Also exclude accounts with no properties as well as properties
         * with no views.
         * @param {Array} oldSummaries The account summaries array in the form
         *   return by the Management API.
         * @return {Array} The trimmed-down account summaries.
         */
        function trimAccountSummaries(oldSummaries) {
          var newSummaries = [];
          oldSummaries.forEach(function(item) {
            var account = {name: item.name, properties: []};
            var properties = item.webProperties || [];
            properties.forEach(function(item) {
              var property = {name: item.name, views: []};
              var views = item.profiles || [];
              views.forEach(function(item) {
                var view = {name: item.name, ids: 'ga:' + item.id};
                property.views.push(view);
              });
              // Only add the property if it has views.
              if (property.views.length) {
                account.properties.push(property);
              }
            });
            // Only add the account if it has properties.
            if (account.properties.length) {
              newSummaries.push(account);
            }
          });
          return newSummaries;
        }

        return {
          /**
           * Return the `requestAccountSummaries` promise. If the promise exists,
           * return it to avoid multiple requests. If the promise does not exist,
           * initiate the request and cache the promise.
           */
          get: function() {
            return promise || (promise =
              requestAccountSummaries()
                .then(trimAccountSummaries)
                .catch(function(err) {
                  console.error(err.stack);
                })
              );
          }
        };
      }());

    }());

  </script>

</polymer-element>
