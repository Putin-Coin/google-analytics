<link rel="import" href="google-analytics-base.html">

<polymer-element
  name="google-analytics-query"
  extends="google-analytics-base"
  attributes="
    data
    output
    ids
    startDate
    endDate
    metrics
    dimensions
    sort
    filters
    maxResults">

  <script>

    (function() {

      Polymer('google-analytics-query', {

        startDate: '7daysAgo',

        endDate: 'yesterday',

        output: 'json',

        data: null,

        observe: {
          ids: 'getData',
          startDate: 'getData',
          endDate: 'getData',
          metrics: 'getData',
          dimensions: 'getData',
          sort: 'getData',
          filters: 'getData',
          maxResults: 'getData'
        },

        analyticsAuthorize: function(data) {
          this.super();
          this.getData();
        },

        getData: function() {
          if (this.authorized && this.isValid()) {
            var query = {
              'ids': this.ids,
              'start-date': this.startDate,
              'end-date': this.endDate,
              'metrics': this.metrics,
              'output': this.output
            };
            if (this.dimensions) query.dimensions = this.dimensions;
            if (this.sort) query.sort = this.sort;
            if (this.filters) query.filters = this.filters;
            if (this.maxResults) query['max-results'] = this.maxResults;

            gapi.client.analytics.data.ga.get(query)
                .execute(this.handleResponse.bind(this));
          }
        },

        handleResponse: function(response) {
          if (response.error) {
            this.fire('analytics-query-error', response.error);
          }
          else {
            this.data = response;
            this.fire('analytics-query-success', response);
          }
        },

        /**
         * The `isValid` method checks to make sure the query contains the
         * minimum parameters necessary for a successful request.
         *
         * @method isValid
         * @return {boolean} - Whether or not the query is valid.
         */
        isValid: function() {
          return !!(this.ids && this.metrics && this.startDate && this.endDate);
        },

      });


    }());

  </script>

</polymer-element>
